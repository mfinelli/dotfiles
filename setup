#!/bin/bash

set -e

# https://stackoverflow.com/a/14367368
function array_contains() {
    local array="$1[@]"
    local item=$2
    local found=1

    for element in "${!array}"; do
        if [[ $element == $item ]]; then
            found=0
            break
        fi
    done

    return $found
}

if ! command -v stow > /dev/null 2>&1; then
    echo >&2 "Stow not found, aborting!"
    exit 1
fi

# check if we're doing just one or all of them
if [[ $# -eq 1 ]]; then
    comp=($1)
else
    if [[ "$(uname)" == "Darwin" ]]; then
        comp=(aws bash git gnupg mutt ssh tmux vim vpn zsh)
    else
        comp=(aws bash git gnupg mutt ssh tmux vim vpn xorg zsh)
    fi
fi

echo "Installing dotfiles for: ${comp[@]}"

# in case we didn't clone recursively
git submodule update --init

if array_contains comp aws; then
    gpg -d aws/.aws/credentials.asc > aws/.aws/credentials
fi

if array_contains comp bash; then
    if [[ -f ~/.bashrc ]]; then
        rm ~/.bashrc
    fi
fi

if array_contains comp mutt; then
    chmod 700 mutt/.mail/{,mario@finel.li,mario@scul.ch}
fi

if array_contains comp ssh; then
    if [[ ! -d ~/.ssh ]]; then
        mkdir ~/.ssh && chmod 700 ~/.ssh
    fi

    if [[ ! -f ~/.ssh/known_hosts ]]; then
        touch ~/.ssh/known_hosts
    fi

    for key in $(ls ssh/.ssh/*.asc); do
        gpg -d $key > ssh/.ssh/$(basename $key .asc) && \
            chmod 600 ssh/.ssh/$(basename $key .asc)
    done
fi

if array_contains comp vpn; then
    for vpn in $(ls vpn/.vpn/*.tgz.asc); do
        gpg -d $vpn | tar zx -C vpn/.vpn
    done
fi

if array_contains comp xorg; then
    if [[ -f ~/.config/user-dirs.dirs ]]; then
        rm ~/.config/user-dirs.dirs
    fi

    if [[ -f ~/.config/user-dirs.locale ]]; then
        rm ~/.config/user-dirs.locale
    fi

    dirs=(Desktop Downloads Templates Public Documents Music Pictures Videos)
    for dir in ${dirs[@]}; do
        mkdir -p ~/$dir
    done
fi

for s in ${comp[@]}; do
    stow $s
done

exit 0
