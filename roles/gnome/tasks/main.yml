---
- name: Enabling gcr for ssh keyring
  ansible.builtin.systemd:
    enabled: true
    name: gcr-ssh-agent.socket
    scope: user

- name: Enabling keyboard layouts
  community.general.dconf:
    key: /org/gnome/desktop/input-sources/sources
    value: "[('xkb', 'us'), ('xkb', 'it')]"

- name: Enabling compose key settings
  community.general.dconf:
    key: /org/gnome/desktop/input-sources/xkb-options
    value: "['lv3:switch', 'compose:ralt']"

- name: Configuring screen lock settings
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: /org/gnome/desktop/screensaver/lock-delay
      value: uint32 0
    - key: /org/gnome/desktop/session/idle-delay
      value: uint32 600
    - key: /org/gnome/desktop/notifications/show-in-lock-screen
      value: "false"

- name: Disabling natural scrolling
  community.general.dconf:
    key: /org/gnome/desktop/peripherals/touchpad/natural-scroll
    value: "false"

- name: Disabling prompt and start program on media insertion
  community.general.dconf:
    key: /org/gnome/desktop/media-handling/autorun-never
    value: "true"

- name: Configuring top-bar clock
  community.general.dconf:
    key: /org/gnome/desktop/interface/{{ item }}
    value: "true"
  loop:
    - clock-show-seconds
    - clock-show-weekday

- name: Configuring clock to use 24-hour time
  community.general.dconf:
    key: "{{ item }}"
    value: "'24h'"
  loop:
    - /org/gnome/desktop/interface/clock-format
    - /org/gtk/settings/file-chooser/clock-format

- name: Configuring World clocks
  ansible.builtin.import_tasks: clocks.yml

- name: Enabling GNOME Shell extensions
  when: ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: /org/gnome/shell/disable-user-extensions
    value: "false"

- name: Activating SimpleWeather extension
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/shell/extensions/simple-weather/is-activated
    value: "true"

- name: Enabling individual GNOME Shell extensions
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/shell/enabled-extensions
    value: "[{{ gnome_extensions[ansible_os_family] | join(', ') }}]"

- name: Configuring GNOME Shell dash-to-dock extension
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/shell/extensions/dash-to-dock/{{ item.key }}
    value: "{{ item.value }}"
  loop:
    - key: dock-position
      value: "'LEFT'"
    - key: extend-height
      value: "true"
    - key: custom-theme-shrink
      value: "true"

- name: Configuring GNOME Shell systemd manager extension
  when: ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: /org/gnome/shell/extensions/systemd-manager/{{ item.key }}
    value: "{{ item.value }}"
  loop:
    - key: show-add
      value: "false"
    - key: command-method
      value: "'systemctl'"

- name: Configuring GNOME Shell systemd manager extension systemd services
  when:
    - ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: /org/gnome/shell/extensions/systemd-manager/systemd
    value: >-
      ['{"name":"Docker","service":"docker.service","type":"system"}']

- name: Configuring dock applications (at work)
  when: ansible_os_family == 'Archlinux' and mtype == 'work'
  community.general.dconf:
    key: /org/gnome/shell/favorite-apps
    value: "[{{ gnome_work_dock | join(', ') }}]"

- name: Configuring dock applications (at home)
  when: ansible_os_family == 'Archlinux' and mtype == 'personal'
  community.general.dconf:
    key: /org/gnome/shell/favorite-apps
    value: "[{{ gnome_personal_dock | join(', ') }}]"

- name: Configuring GNOME Shell Arc Menu extension icon (arch)
  when: ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: /org/gnome/shell/extensions/arcmenu/distro-icon
    value: 6

- name: Configuring GNOME Shell Arc Menu extension icon (debian)
  when: ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/shell/extensions/arcmenu/distro-icon
    value: 1

- name: Configuring GNOME Shell Arc Menu extension
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: /org/gnome/shell/extensions/arcmenu/menu-layout
      value: "'Default'"
    - key: /org/gnome/shell/extensions/arcmenu/show-external-devices
      value: "false"
    - key: /org/gnome/shell/extensions/arcmenu/pinned-app-list
      value: "@as []"
    - key: /org/gnome/shell/extensions/arcmenu/default-menu-view
      value: "'Frequent_Apps'"
    - key: /org/gnome/shell/extensions/arcmenu/searchbar-default-bottom-location
      value: "'Top'"

- name: Enabling location services # required for night light
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/system/location/enabled
    value: "true"

- name: Configuring GNOME Night Light
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: "/org/gnome/settings-daemon/plugins/color/{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: night-light-enabled
      value: "true"
    - key: night-light-schedule-automatic
      value: "true"

- name: Configuring wellbeing
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/desktop/break-reminders/selected-breaks
    value: "['eyesight', 'movement']"

# https://github.com/blueman-project/blueman/issues/2411
- name: Setting blueman applet to use symbolic status icons
  when: ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: /org/blueman/general/symbolic-status-icons
    value: "true"

- name: Configuring GNOME Interface fonts
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: /org/gnome/desktop/interface/font-name
      value: "'Ubuntu 11'"
    - key: /org/gnome/desktop/wm/preferences/titlebar-font
      value: "'Ubuntu Bold 11'"
    - key: /org/gnome/desktop/interface/document-font-name
      value: "'Ubuntu 11'"

- name: Setting GNOME Overview shortcut to "Right Super"
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: /org/gnome/mutter/overlay-key
    value: "'Super_R'"

- name: Configuring blur-my-shell-extension
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    # disables the corners on the dash-to-dock
    key: /org/gnome/shell/extensions/blur-my-shell/dash-to-dock/pipeline
    value: "'pipeline_default'"

# ID taken from observing `dconf watch /` but I don't think that it matters
- name: Configuring GNOME random wallpaper local source
  when: ansible_os_family == 'Archlinux'
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: "/org/gnome/shell/extensions/space-iflow-randomwallpaper/\
        sources/general/1717579799622/name"
      value: "'Local'"
    - key: "/org/gnome/shell/extensions/space-iflow-randomwallpaper/\
        sources/localFolder/1717579799622/folder"
      value: "'{{ ansible_user_dir }}/.local/share/backgrounds'"
    - key: /org/gnome/shell/extensions/space-iflow-randomwallpaper/sources
      value: "['1717579799622']"
    - key: "/org/gnome/shell/extensions/space-iflow-randomwallpaper/\
        fetch-on-startup"
      value: "true"

- name: Configuring SimpleWeather extension
  when: ansible_os_family == 'Archlinux' or ansible_os_family == 'Debian'
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - key: /org/gnome/shell/extensions/simple-weather/theme
      value: "'immersive'"
    - key: /org/gnome/shell/extensions/simple-weather/symbolic-icons-panel
      value: "true"
    - key: /org/gnome/shell/extensions/simple-weather/locations
      value: >-
        ['{"isHere":true}', '{"name":"Siena","lat":43.167206,"lon":11.467561}',
        '{"name":"Washington","lat":38.8950368,"lon":-77.0365427}']

- name: Configuring GNOME Terminal
  ansible.builtin.import_tasks: terminal.yml
